icon: https://apps.okteto.com/movies/icon.png

build:
  catalog:
    context: catalog
  rent:
    context: rent

deploy:
  - name: Deploy PostgreSQL
    command: |
      # If we get a snapshot name passed into the deployment we will add two annotations to the persistent volume for PostgreSQL.
      # These annotations tell Okteto to create the volume from an existing snapshot. 
      # Details in https://www.okteto.com/docs/self-hosted/administration/volume-snapshots/#consuming-a-volume-snapshot-created-in-kubernetes 
      if [ -z $DB_SNAPSHOT_NAME ]; then
        helm upgrade --install postgresql postgresql/postgresql-11.6.21.tgz -f postgresql/values.yml --version 11.6.21
      else
        helm upgrade --install postgresql postgresql/postgresql-11.6.21.tgz \
        -f postgresql/values.yml \
        --version 11.6.21 \
        --set primary.persistence.annotations."dev\.okteto\.com/from-snapshot-name"="$DB_SNAPSHOT_NAME" \
        --set primary.persistence.annotations."dev\.okteto\.com/from-snapshot-namespace"="$DB_SNAPSHOT_NAMESPACE"
      fi
  - name: Deploy Kafka
    command:  helm upgrade --install kafka kafka/kafka-18.0.3.tgz -f kafka/values.yml --version 18.0.3
  - name: Deploy MongoDB
    command:  helm upgrade --install mongodb mongodb/mongodb-12.1.30.tgz -f mongodb/values.yml --version 12.1.30
  - name: Deploy Catalog
    command: helm upgrade --install catalog catalog/chart --set image=${OKTETO_BUILD_CATALOG_IMAGE}
  - name: Deploy Rent
    command: helm upgrade --install rent rent/chart --set image=${OKTETO_BUILD_RENT_IMAGE}

dev:
  catalog:
    command: yarn start
    sync:
      - catalog:/src
    forward:
      - 9229:9229
  rent:
    command: mvn spring-boot:run
    sync:
      - rent:/app
    volumes:
      - /root/.m2
    forward:
      - 5005:5005
